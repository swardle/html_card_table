<!DOCTYPE HTML>
<html>
<script src="js/CardSprites.js"></script>


<head>
    <link rel="stylesheet" type="text/css" href="css/style.css">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<script>
    function DrawCardContainers(hands, numPlayer) {
        for (let player_index = 0; player_index < numPlayer; player_index++) {
            let cardpos = 0;
            let div = document.getElementById(`CardContainer${player_index}`);
            div.innerHTML = "";
            hands[player_index].sort(sortCardsByValue);
            for (const card of hands[player_index]) {                
                const str = `<img id="${cardToSpriteFileName(card)}" class="Cards" ` + 
                    `src="img/${cardToSpriteFileName(card)}" ` +
                    `style="transform: translate(${cardpos * 1.5}em, ${0}em);">`
                div.innerHTML += str;
                cardpos++;
            }
        }

        const items = document.querySelectorAll('.Cards');

        items.forEach(item => {
            item.addEventListener('dragstart', dragStart);
        });

        function dragStart(e) {
            // sort the card that we are moving
            e.dataTransfer.setData('text/plain', e.target.id);
            const id = e.target.id
            console.log(`e.dataTransfer.setData = ${id}`)

            // find the card in the user hands and remove it
            const container = e.target.parentNode
            const container_id = container.id.replace("CardContainer","");                        
            const len = hands[container_id].length
            for (let i = 0; i < len; i++) {
                const card = hands[container_id][i];
                if (cardToSpriteFileName(card) === id) {
                    hands[container_id].splice(i, 1);
                    break;
                }
            }

            // remove the card from the container only once it is dragged.
            setTimeout(() => {
                e.target.classList.add('HideCard');
            }, 0);
        }
    }
    window.addEventListener('load', function () {
        let deck = CreateDeck();
        let hands = []
        let numPlayer = 3
        for (let i = 0; i < numPlayer; i++) {
            hands.push([]);
        }

        // deal all of the cards
        while (deck.length != 0) {
            for (let i = 0; i < numPlayer; i++) {
                let card = deck.pop();
                hands[i].push(card)
                if (deck.length == 0) {
                    break;
                }
            }
        }

        DrawCardContainers(hands, numPlayer)

        const boxes = document.querySelectorAll('.CardContainer');

        boxes.forEach(box => {
            box.addEventListener('dragenter', dragEnter)
            box.addEventListener('dragover', dragOver);
            box.addEventListener('dragleave', dragLeave);
            box.addEventListener('drop', drop);
        });



        function dragEnter(e) {
            // enable drag and drop on the item
            e.preventDefault();
            // change the style of the CardContainer
            // when the card could be dropped on this CardContainer
            e.currentTarget.classList.add('OverCardContainer');
        }

        function dragOver(e) {
            // enable drag and drop on the item
            e.preventDefault();
            // change the style of the CardContainer
            // when the card could be dropped on this CardContainer
            e.currentTarget.classList.add('OverCardContainer');
        }

        function dragLeave(e) {
            e.currentTarget.classList.remove('OverCardContainer');
        }

        function drop(e) {
            e.currentTarget.classList.remove('OverCardContainer');
            // get the draggable element
            const id = e.dataTransfer.getData('text/plain');
            console.log(`e.dataTransfer.getData = ${id}`)
            const draggable = document.getElementById(id);

            // add it to the drop target
            e.currentTarget.appendChild(draggable);
            let container_id = e.currentTarget.id.replace("CardContainer","");

            // sort the and position cards
            hands[container_id].push(SpriteFileNameToCard(id));
            DrawCardContainers(hands, numPlayer);

            // display the draggable element
            draggable.classList.remove('HideCard');            
        }
    })
</script>


<body>

    <h2>Card</h2>

    <div id="CardContainer0" class="CardContainer">
    </div>

    <div id="CardContainer1" class="CardContainer">
    </div>

    <div id="CardContainer2" class="CardContainer">
    </div>

</body>

</html>